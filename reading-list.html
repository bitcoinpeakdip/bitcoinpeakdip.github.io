<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-HR78BDQYJJ"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-HR78BDQYJJ');
    </script>     
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading List - Bitcoin PeakDip</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .reading-list-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        
        .reading-list-title {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .reading-list-title h1 {
            font-size: 2.5em;
            background: linear-gradient(to right, var(--wave-trough), var(--wave-peak));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .reading-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .reading-item:hover {
            border-color: var(--wave-trough);
            transform: translateX(5px);
        }
        
        .reading-item-info h3 {
            color: white;
            margin-bottom: 8px;
        }
        
        .reading-item-info p {
            color: var(--text-glow);
            font-size: 0.9em;
        }
        
        .reading-item-actions {
            display: flex;
            gap: 10px;
        }
        
        .reading-btn {
            background: rgba(0,212,255,0.1);
            border: 1px solid var(--wave-trough);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 14px;
        }
        
        .reading-btn:hover {
            background: var(--wave-trough);
            color: black;
        }
        
        .reading-btn.delete {
            border-color: var(--wave-peak);
        }
        
        .reading-btn.delete:hover {
            background: var(--wave-peak);
        }
        
        .empty-list {
            text-align: center;
            padding: 50px;
            color: var(--text-glow);
        }
        
        .empty-list i {
            font-size: 4em;
            color: var(--wave-mid);
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Th√™m d√≤ng n√†y c√πng v·ªõi c√°c script kh√°c -->
    <script src="js/reading-list.js"></script>

    <!-- Sau ƒë√≥ c√≥ th·ªÉ s·ª≠ d·ª•ng -->
    <script>
        // V√≠ d·ª•: x√≥a t·∫•t c·∫£
        document.getElementById('clearAllBtn').onclick = function() {
            readingList.clearAll();
            loadReadingList(); // H√†m hi·ªán c√≥
        };
    </script>    
    <script>
        // PH√ÅT HI·ªÜN MOBILE V√Ä V√î HI·ªÜU H√ìA HI·ªÜU ·ª®NG
        (function() {
            // Ki·ªÉm tra user agent ho·∫∑c k√≠ch th∆∞·ªõc m√†n h√¨nh
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
            
            if (isMobile) {
                console.log('üì± Mobile detected on this page: Disabling heavy effects');
                // G√°n bi·∫øn to√†n c·ª•c
                window.IS_MOBILE = true;
                
                // Th√™m class v√†o body ƒë·ªÉ CSS x·ª≠ l√Ω
                document.body.classList.add('mobile-device');
            } else {
                window.IS_MOBILE = false;
            }
        })();
    </script>     
    <div class="content-container">
        <div class="reading-list-container">
            <div class="reading-list-title">
                <h1><i class="fas fa-bookmark"></i> Reading List</h1>
                <p>Articles saved for later</p>
            </div>
            
            <div id="readingList" class="reading-list">
                <!-- JS will populate here -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <a href="learn.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i> Back to Learn
                </a>
            </div>
        </div>
    </div>
    
    <script>
        function loadReadingList() {
            const container = document.getElementById('readingList');
            const readingList = JSON.parse(localStorage.getItem('reading_list') || '[]');
            
            if (readingList.length === 0) {
                container.innerHTML = `
                    <div class="empty-list">
                        <i class="fas fa-book-open"></i>
                        <h3>Your reading list is empty</h3>
                        <p>Save articles from notifications to read them later</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            readingList.sort((a, b) => new Date(b.savedAt) - new Date(a.savedAt));
            
            readingList.forEach((item, index) => {
                const date = new Date(item.savedAt).toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                html += `
                    <div class="reading-item" data-id="${item.id}">
                        <div class="reading-item-info">
                            <h3>${item.title}</h3>
                            <p><i class="fas fa-clock"></i> Saved on ${date}</p>
                        </div>
                        <div class="reading-item-actions">
                            <a href="${item.url}" class="reading-btn">
                                <i class="fas fa-book-open"></i> Read
                            </a>
                            <button class="reading-btn delete" onclick="deleteFromList('${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        window.deleteFromList = function(id) {
            let readingList = JSON.parse(localStorage.getItem('reading_list') || '[]');
            readingList = readingList.filter(item => item.id !== id);
            localStorage.setItem('reading_list', JSON.stringify(readingList));
            loadReadingList();
            
            // Show toast
            const toast = document.createElement('div');
            toast.className = 'toast-notification toast-success';
            toast.innerHTML = '<i class="fas fa-check"></i><span>Removed from reading list</span>';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
        // ========== X·ª¨ L√ù PENDING ITEMS T·ª™ SERVICE WORKER ==========
        function checkPendingSave() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('pending') === 'true') {
                // Ki·ªÉm tra cache xem c√≥ item pending kh√¥ng
                if ('caches' in window) {
                    caches.open('reading-list-queue').then(cache => {
                        cache.match('pending-save').then(response => {
                            if (response) {
                                response.json().then(articleData => {
                                    // Th√™m v√†o reading list
                                    let readingList = JSON.parse(localStorage.getItem('reading_list') || '[]');
                                    
                                    const exists = readingList.some(item => item.id === articleData.id);
                                    if (!exists) {
                                        readingList.push({
                                            id: articleData.id,
                                            title: articleData.title,
                                            url: articleData.url,
                                            savedAt: new Date().toISOString(),
                                            publishedDate: articleData.date
                                        });
                                        
                                        localStorage.setItem('reading_list', JSON.stringify(readingList));
                                        
                                        // X√≥a kh·ªèi cache
                                        cache.delete('pending-save');
                                        
                                        // Hi·ªÉn th·ªã th√¥ng b√°o
                                        const toast = document.createElement('div');
                                        toast.className = 'toast-notification toast-success';
                                        toast.innerHTML = '<i class="fas fa-check"></i><span>Article saved to reading list</span>';
                                        document.body.appendChild(toast);
                                        setTimeout(() => toast.remove(), 3000);
                                    }
                                    
                                    loadReadingList();
                                    updateReadingListBadge();
                                });
                            }
                        });
                    });
                }
            }
        }
        
        // ========== L·∫ÆNG NGHE MESSAGE T·ª™ SERVICE WORKER ==========
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('üì® Message from service worker:', event.data);
                
                if (event.data.type === 'SAVE_FOR_LATER' && event.data.article) {
                    // Th√™m v√†o reading list
                    let readingList = JSON.parse(localStorage.getItem('reading_list') || '[]');
                    
                    const exists = readingList.some(item => item.id === event.data.article.id);
                    if (!exists) {
                        readingList.push({
                            id: event.data.article.id,
                            title: event.data.article.title,
                            url: event.data.article.url || `/learn/article.html?id=${event.data.article.slug}`,
                            savedAt: new Date().toISOString(),
                            publishedDate: event.data.article.date
                        });
                        
                        localStorage.setItem('reading_list', JSON.stringify(readingList));
                        
                        // C·∫≠p nh·∫≠t badge
                        updateReadingListBadge();
                        
                        // Reload list n·∫øu ƒëang ·ªü trang reading list
                        if (window.location.pathname.includes('reading-list.html')) {
                            loadReadingList();
                            
                            // Hi·ªÉn th·ªã th√¥ng b√°o
                            const toast = document.createElement('div');
                            toast.className = 'toast-notification toast-success';
                            toast.innerHTML = '<i class="fas fa-check"></i><span>New article added to reading list</span>';
                            document.body.appendChild(toast);
                            setTimeout(() => toast.remove(), 3000);
                        }
                    }
                }
                
                if (event.data.type === 'READING_LIST_UPDATED') {
                    // C·∫≠p nh·∫≠t badge
                    updateReadingListBadge();
                    
                    // Reload n·∫øu ƒëang ·ªü trang reading list
                    if (window.location.pathname.includes('reading-list.html')) {
                        loadReadingList();
                    }
                }
            });
        }
        
        // ========== H√ÄM C·∫¨P NH·∫¨T BADGE ==========
        function updateReadingListBadge() {
            const badge = document.getElementById('readingListBadge');
            if (badge) {
                const count = JSON.parse(localStorage.getItem('reading_list') || '[]').length;
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline' : 'none';
            }
            
            // Update mobile badge n·∫øu c√≥
            const mobileBadge = document.querySelector('.reading-list-badge-mobile');
            if (mobileBadge) {
                const count = JSON.parse(localStorage.getItem('reading_list') || '[]').length;
                mobileBadge.textContent = count > 9 ? '9+' : count;
                mobileBadge.style.display = count > 0 ? 'flex' : 'none';
            }
            
            // Update PWA app badge
            if (navigator.setAppBadge) {
                const count = JSON.parse(localStorage.getItem('reading_list') || '[]').length;
                navigator.setAppBadge(count).catch(() => {});
            } else if (navigator.setExperimentalAppBadge) {
                const count = JSON.parse(localStorage.getItem('reading_list') || '[]').length;
                navigator.setExperimentalAppBadge(count).catch(() => {});
            }
        }
        
        // ========== INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            loadReadingList();
            checkPendingSave();
            updateReadingListBadge();
            
            // L·∫Øng nghe s·ª± thay ƒë·ªïi t·ª´ tab kh√°c
            window.addEventListener('storage', (e) => {
                if (e.key === 'reading_list') {
                    loadReadingList();
                    updateReadingListBadge();
                }
            });
        });        
    </script>
    <script src="js/notifications.js?v=2.0.0"></script>
</body>
</html>